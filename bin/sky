#!/usr/bin/env ruby

$:.unshift(File.join(File.dirname(File.expand_path(__FILE__)), '..', 'lib'))

require 'rubygems'
require 'skydb'
require 'skydb/import'
require 'commander/import'

program :name, 'Sky'
program :version, SkyDB::VERSION
program :description, 'A multi-purpose utilty for the Sky database.'


################################################################################
# Import
################################################################################

command :import do |c|
  c.syntax = 'sky import FILE'
  c.description = 'Imports data from a text file into a Sky table.'
  c.option('--table STRING', 'The name of the table to import to.')
  c.option('--format STRING', 'The YAML format file to import with.')
  c.when_called do|args, options|
    # Setup importer.
    importer = SkyDB::Import::Importer.new()
    importer.table_name = options.table || ask("Table: ")
    
    # Load transform files by name.
    formats = options.format || ask("Format: ")
    formats.split(',').each do |format|
      begin
        importer.load_transform_file(format)
      rescue SkyDB::Import::Importer::TransformNotFound => e
        puts "ERROR: #{e.message}\n\n"
        exit(1)
      end
    end
    
    # Import!
    importer.import(args)
  end
end
